{
    "name": "propertiesCRUD",
    "description": "Workflow para CRUD de imóveis",
    "blueprint_spec": {
        "lanes": [
            {
                "id": "B",
                "name": "Backoffice",
                "rule": {
                    "$js": "({actor_data}) => actor_data.claims.includes('adminProperties')"
                }
            }
        ],
        "nodes": [
            {
                "id": "S",
                "name": "Start Workflow",
                "next": "ST5",
                "type": "Start",
                "lane_id": "B",
                "parameters": {
                    "input_schema": {}
                }
            },
            {
                "id": "ST5",
                "name": "Get user properties projects",
                "next": "SB1",
                "type": "SystemTask",
                "lane_id": "B",
                "category": "HTTP",
                "parameters": {
                    "input": {},
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.POSTGREST}}}/properties_projects"
                        },
                        "verb": "GET",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        203,
                        204
                    ]
                }
            },
            {
                "id": "SB1",
                "name": "Set properties projects to Bag",
                "next": "ST1",
                "type": "SystemTask",
                "lane_id": "B",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "properties_projects": {
                            "$ref": "result.data"
                        }
                    }
                }
            },
            {
                "id": "ST1",
                "name": "Request to Mock.io",
                "next": "U1",
                "type": "SystemTask",
                "lane_id": "B",
                "category": "HTTP",
                "parameters": {
                    "input": {},
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.SERVICE_API}}}/rpc/properties"
                        },
                        "verb": "GET",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    }
                }
            },
            {
                "id": "U1",
                "name": "User selects what wanna to do",
                "next": "SET-ACTION-TO-BAG",
                "type": "UserTask",
                "lane_id": "B",
                "parameters": {
                    "input": {
                        "properties": {
                            "$ref": "result.data"
                        },
                        "activity_schema": {
                            "type": "object",
                            "required": [
                                "action"
                            ],
                            "properties": {
                                "ack": {
                                    "type": "boolean"
                                },
                                "size": {
                                    "type": "number"
                                },
                                "text": "Tem certeza que deseja apagar o imóvel? A ação não poderá ser desfeita.",
                                "price": {
                                    "type": "string"
                                },
                                "title": "Apagar",
                                "action": {
                                    "type": "string"
                                },
                                "images": {
                                    "type": "array"
                                },
                                "option": {
                                    "type": "string"
                                },
                                "address": {
                                    "type": "string"
                                },
                                "buttons": [
                                    {
                                        "type": "primary",
                                        "label": "Sim"
                                    },
                                    {
                                        "type": "secondary",
                                        "label": "Cancelar"
                                    }
                                ],
                                "property_type": {
                                    "type": "string"
                                },
                                "properties_projects_id": {
                                    "type": "string"
                                }
                            },
                            "additionalProperties": false
                        },
                        "properties_projects": {
                            "$ref": "bag.properties_projects"
                        }
                    },
                    "action": "USER_CHOOSE_ACTION_PROPERTIES_CRUD"
                }
            },
            {
                "id": "SET-ACTION-TO-BAG",
                "name": "Set action on bag",
                "next": "F1",
                "type": "SystemTask",
                "lane_id": "B",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "action": {
                            "$ref": "result.activities[0].data.action"
                        }
                    }
                }
            },
            {
                "id": "F1",
                "name": "Check action",
                "next": {
                    "CREATE": "F3",
                    "DELETE": "F2",
                    "UPDATE": "F4",
                    "default": "E",
                    "RETURN_LIST": "ST5"
                },
                "type": "Flow",
                "lane_id": "B",
                "parameters": {
                    "input": {
                        "key": {
                            "$ref": "bag.action"
                        }
                    }
                }
            },
            {
                "id": "U3",
                "name": "User insert information to create an enterprise",
                "next": "F3",
                "type": "UserTask",
                "lane_id": "B",
                "parameters": {
                    "input": {
                        "activity_schema": {
                            "type": "object",
                            "required": [
                                "price",
                                "size",
                                "address",
                                "property_type",
                                "images"
                            ],
                            "properties": {
                                "id": {
                                    "type": "string"
                                },
                                "size": {
                                    "type": "number"
                                },
                                "price": {
                                    "type": "string"
                                },
                                "images": {
                                    "type": "array"
                                },
                                "option": {
                                    "type": "string"
                                },
                                "address": {
                                    "type": "string"
                                },
                                "property_type": {
                                    "type": "string"
                                },
                                "properties_projects_id": {
                                    "type": "string"
                                }
                            },
                            "additionalProperties": false
                        },
                        "properties_projects": {
                            "$ref": "bag.properties_projects"
                        }
                    },
                    "action": "CREATE_PROPERTY"
                }
            },
            {
                "id": "F3",
                "name": "Check payload to create",
                "next": {
                    "return": "ST5",
                    "default": "ST2"
                },
                "type": "Flow",
                "lane_id": "B",
                "parameters": {
                    "input": {
                        "key": {
                            "$ref": "result.activities[0].data.option"
                        }
                    }
                }
            },
            {
                "id": "ST2",
                "name": "Request to create an enterprise",
                "next": "CONFIRMATION-MESSAGE",
                "type": "SystemTask",
                "lane_id": "B",
                "category": "HTTP",
                "parameters": {
                    "input": {
                        "data": {
                            "$ref": "result.activities[0].data"
                        }
                    },
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.SERVICE_API}}}/rpc/properties"
                        },
                        "verb": "POST",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    }
                }
            },
            {
                "id": "U4",
                "name": "User insert information to UPDATE info",
                "next": "F4",
                "type": "UserTask",
                "lane_id": "B",
                "parameters": {
                    "input": {
                        "activity_schema": {
                            "type": "object",
                            "required": [
                                "id"
                            ],
                            "properties": {
                                "id": {
                                    "type": "string"
                                },
                                "size": {
                                    "type": "number"
                                },
                                "price": {
                                    "type": "string"
                                },
                                "images": {
                                    "type": "array"
                                },
                                "option": {
                                    "type": "string"
                                },
                                "address": {
                                    "type": "string"
                                },
                                "property_type": {
                                    "type": "string"
                                },
                                "properties_projects_id": {
                                    "type": "string"
                                }
                            }
                        },
                        "properties_projects": {
                            "$ref": "bag.properties_projects"
                        }
                    },
                    "action": "UPDATE_PROPERTY"
                }
            },
            {
                "id": "F4",
                "name": "Check option to update",
                "next": {
                    "return": "ST5",
                    "default": "B2"
                },
                "type": "Flow",
                "lane_id": "B",
                "parameters": {
                    "input": {
                        "key": {
                            "$ref": "result.activities[0].data.option"
                        }
                    }
                }
            },
            {
                "id": "B2",
                "name": "Set enterprise's id to bag",
                "next": "ST3",
                "type": "SystemTask",
                "lane_id": "B",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "id": {
                            "$ref": "result.activities[0].data.id"
                        },
                        "new_data": {
                            "$ref": "result.activities[0].data"
                        }
                    }
                }
            },
            {
                "id": "ST3",
                "name": "Request to update an enterprise",
                "next": "CONFIRMATION-MESSAGE",
                "type": "SystemTask",
                "lane_id": "B",
                "category": "HTTP",
                "parameters": {
                    "input": {
                        "data": {
                            "$ref": "bag.new_data"
                        }
                    },
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.SERVICE_API}}}/rpc/properties/{{bag.id}}"
                        },
                        "verb": "PUT",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    }
                }
            },
            {
                "id": "U2",
                "name": "Confirm delete",
                "next": "F2",
                "type": "UserTask",
                "lane_id": "B",
                "parameters": {
                    "input": {
                        "text": "Tem certeza que deseja apagar o imóvel? A ação não poderá ser desfeita.",
                        "title": "Apagar",
                        "buttons": [
                            {
                                "type": "primary",
                                "label": "Sim"
                            },
                            {
                                "type": "secondary",
                                "label": "Cancelar"
                            }
                        ],
                        "activity_schema": {
                            "type": "object",
                            "required": [
                                "ack"
                            ],
                            "properties": {
                                "id": {
                                    "type": "string"
                                },
                                "action": {
                                    "type": "boolean"
                                }
                            },
                            "additionalProperties": false
                        }
                    },
                    "action": "CONFIRM_DELETE_PROPERTY"
                }
            },
            {
                "id": "F2",
                "name": "Check ACK delete",
                "next": {
                    "true": "B1",
                    "false": "ST5",
                    "default": "ST5"
                },
                "type": "Flow",
                "lane_id": "B",
                "parameters": {
                    "input": {
                        "key": {
                            "$ref": "result.activities[0].data.ack"
                        }
                    }
                }
            },
            {
                "id": "B1",
                "name": "Set enterprise's id to Bag",
                "next": "ST4",
                "type": "SystemTask",
                "lane_id": "B",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "id": {
                            "$ref": "result.activities[0].data.id"
                        }
                    }
                }
            },
            {
                "id": "ST4",
                "name": "Request to delete an enterprise",
                "next": "CONFIRMATION-MESSAGE",
                "type": "SystemTask",
                "lane_id": "B",
                "category": "HTTP",
                "parameters": {
                    "input": {},
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.SERVICE_API}}}/rpc/properties/{{bag.id}}"
                        },
                        "verb": "DELETE",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    }
                }
            },
            {
                "id": "CONFIRMATION-MESSAGE",
                "name": "Request made message",
                "next": "SET-ACTION-TO-BAG",
                "type": "UserTask",
                "lane_id": "B",
                "parameters": {
                    "input": {
                        "action": {
                            "$ref": "bag.action"
                        },
                        "confirm_message": true
                    },
                    "action": "CONFIRMATION_MESSAGE_TO_USER_TO_PROPERTIES",
                    "activity_schema": {
                        "type": "object",
                        "properties": {
                            "action": {
                                "type": "string"
                            }
                        },
                        "additionalProperties": false
                    }
                }
            },
            {
                "id": "E",
                "name": "Finish",
                "next": null,
                "type": "Finish",
                "lane_id": "B"
            }
        ],
        "prepare": [],
        "environment": {
            "POSTGREST": "POSTGREST",
            "SERVICE_API": "SERVICE_API"
        },
        "requirements": [
            "core"
        ]
    }
}