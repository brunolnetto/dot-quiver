{
    "name": "resetPassword",
    "description": "Workflow para recuperar senha",
    "blueprint_spec": {
        "lanes": [
            {
                "id": "ANONYMOUS",
                "name": "Anonymous",
                "rule": {
                    "$js": "({actor_data}) => actor_data.claims.includes('anonymous')"
                }
            },
            {
                "id": "VALID-ACTOR",
                "name": "ValidActor",
                "rule": {
                    "$js": "({actor_data, bag}) => actor_data.session_id == bag.session_id"
                }
            }
        ],
        "nodes": [
            {
                "id": "S",
                "name": "Start Workflow",
                "next": "RESET-PASSWORD-1",
                "type": "Start",
                "lane_id": "ANONYMOUS",
                "parameters": {
                    "input_schema": {}
                }
            },
            {
                "id": "RESET-PASSWORD-1",
                "name": "Verify if phone number is provided",
                "next": {
                    "true": "RESET-PASSWORD-5",
                    "default": "RESET-PASSWORD-2"
                },
                "type": "Flow",
                "lane_id": "ANONYMOUS",
                "parameters": {
                    "input": {
                        "key": {
                            "$ref": "result.data"
                        }
                    }
                }
            },
            {
                "id": "RESET-PASSWORD-2",
                "name": "Submit phone number",
                "next": "RESET-PASSWORD-3",
                "type": "UserTask",
                "lane_id": "ANONYMOUS",
                "parameters": {
                    "input": {},
                    "action": "SUBMIT_ACTOR",
                    "activity_schema": {
                        "type": "object",
                        "required": [
                            "actor"
                        ],
                        "properties": {
                            "actor": {
                                "type": "string"
                            }
                        },
                        "additionalProperties": false
                    }
                }
            },
            {
                "id": "RESET-PASSWORD-3",
                "name": "Set phone number to bag",
                "next": "RESET-PASSWORD-4",
                "type": "SystemTask",
                "lane_id": "ANONYMOUS",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "actor": {
                            "$ref": "result.activities[0].data.actor"
                        }
                    }
                }
            },
            {
                "id": "RESET-PASSWORD-4",
                "name": "Get account settings",
                "next": "RESET-PASSWORD-5",
                "type": "SystemTask",
                "lane_id": "ANONYMOUS",
                "category": "HTTP",
                "parameters": {
                    "input": {},
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.POSTGREST}}}/profiles?mobile_phone=eq.{{bag.actor}}&role=eq.BACKOFFICE&status=eq.active"
                        },
                        "verb": "GET",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        203,
                        204
                    ]
                }
            },
            {
                "id": "RESET-PASSWORD-5",
                "name": "Verify if phone number exists",
                "next": {
                    "true": "RESET-PASSWORD-5-1",
                    "default": "RESET-PASSWORD-5-B-1"
                },
                "type": "Flow",
                "lane_id": "ANONYMOUS",
                "parameters": {
                    "input": {
                        "key": {
                            "$js": "({result}) => !result.data[0] ? null : !!result.data[0].mobile_phone"
                        }
                    }
                }
            },
            {
                "id": "RESET-PASSWORD-5-B-1",
                "name": "Notify invalid phone number",
                "next": "RESET-PASSWORD-2",
                "type": "UserTask",
                "lane_id": "ANONYMOUS",
                "parameters": {
                    "input": {
                        "message": "Não é possivel continuar!",
                        "toggleModal": true
                    },
                    "action": "NOTIFY_FAILURE",
                    "timeout": 2
                }
            },
            {
                "id": "RESET-PASSWORD-5-1",
                "name": "Set session id to bag",
                "next": "RESET-PASSWORD-5-A-1",
                "type": "SystemTask",
                "lane_id": "VALID-ACTOR",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "session_id": {
                            "$ref": "actor_data.session_id"
                        }
                    }
                }
            },
            {
                "id": "RESET-PASSWORD-5-A-1",
                "name": "Saves phone generate Token and Set To Bag",
                "next": "RESET-PASSWORD-5-A-2",
                "type": "SystemTask",
                "lane_id": "VALID-ACTOR",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "token": {
                            "$js": "() => `${Math.floor(1000 + Math.random() * 9000)}`"
                        }
                    }
                }
            },
            {
                "id": "RESET-PASSWORD-5-A-2",
                "name": "Send token sms",
                "next": "RESET-PASSWORD-5-A-3",
                "type": "SystemTask",
                "lane_id": "VALID-ACTOR",
                "category": "HTTP",
                "parameters": {
                    "input": {
                        "phone": {
                            "$ref": "bag.actor"
                        },
                        "message": {
                            "$mustache": "Utilize o token {{bag.token}} para realizar sua requisição"
                        }
                    },
                    "request": {
                        "url": {
                            "$mustache": "http://aprova_services:3000/rpc/token/send"
                        },
                        "verb": "POST",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200
                    ]
                }
            },
            {
                "id": "RESET-PASSWORD-5-A-3",
                "name": "Submit token received",
                "next": "RESET-PASSWORD-5-A-4",
                "type": "UserTask",
                "lane_id": "VALID-ACTOR",
                "parameters": {
                    "input": {
                        "toggleModal": true,
                        "activity_schema": {
                            "type": "object",
                            "properties": {
                                "token": {
                                    "type": "string"
                                }
                            },
                            "additionalProperties": false
                        }
                    },
                    "action": "SUBMIT_TOKEN",
                    "timeout": 300
                }
            },
            {
                "id": "RESET-PASSWORD-5-A-4",
                "name": "Set submited token to bag",
                "next": "RESET-PASSWORD-5-A-5",
                "type": "SystemTask",
                "lane_id": "VALID-ACTOR",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "submited_token": {
                            "$ref": "result.activities[0].data.token"
                        }
                    }
                }
            },
            {
                "id": "RESET-PASSWORD-5-A-5",
                "name": "Check if timeout is expired",
                "next": {
                    "true": "FINISH",
                    "default": "RESET-PASSWORD-5-A-6"
                },
                "type": "Flow",
                "lane_id": "VALID-ACTOR",
                "parameters": {
                    "input": {
                        "$js": "({result}) => result.is_continous"
                    }
                }
            },
            {
                "id": "RESET-PASSWORD-5-A-6",
                "name": "Verify to submited token",
                "next": {
                    "true": "FINISH",
                    "default": "RESET-PASSWORD-5-A-7"
                },
                "type": "Flow",
                "lane_id": "VALID-ACTOR",
                "parameters": {
                    "input": {
                        "$js": "({bag}) => bag.submited_token"
                    }
                }
            },
            {
                "id": "RESET-PASSWORD-5-A-7",
                "name": "verify token is valid",
                "next": {
                    "true": "RESET-PASSWORD-5-A-8",
                    "default": "RESET-PASSWORD-5-C-1"
                },
                "type": "Flow",
                "lane_id": "VALID-ACTOR",
                "parameters": {
                    "input": {
                        "key": {
                            "$js": "({bag}) => bag.token == bag.submited_token"
                        }
                    }
                }
            },
            {
                "id": "RESET-PASSWORD-5-C-1",
                "name": "Notify token is invalid",
                "next": "FINISH",
                "type": "UserTask",
                "lane_id": "VALID-ACTOR",
                "parameters": {
                    "input": {
                        "toggleModal": true,
                        "activity_schema": {
                            "type": "object",
                            "required": [
                                "action"
                            ],
                            "properties": {
                                "message": {
                                    "type": "string"
                                }
                            },
                            "additionalProperties": false
                        }
                    },
                    "action": "NOTIFY_FAILURE",
                    "timeout": 2
                }
            },
            {
                "id": "RESET-PASSWORD-5-A-8",
                "name": "Submit new password",
                "next": "RESET-PASSWORD-5-A-9",
                "type": "UserTask",
                "lane_id": "VALID-ACTOR",
                "parameters": {
                    "input": {
                        "toggleModal": true,
                        "activity_schema": {
                            "type": "object",
                            "required": [
                                "new_password",
                                "confirm_password"
                            ],
                            "properties": {
                                "new_password": {
                                    "type": "string"
                                },
                                "confirm_password": {
                                    "type": "string"
                                }
                            },
                            "additionalProperties": false
                        }
                    },
                    "action": "SUBMIT_PASSWORD"
                }
            },
            {
                "id": "RESET-PASSWORD-5-A-9",
                "name": "Set password to bag",
                "next": "RESET-PASSWORD-5-A-10",
                "type": "SystemTask",
                "lane_id": "VALID-ACTOR",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "new_password": {
                            "$ref": "result.activities[0].data.new_password"
                        },
                        "confirm_password": {
                            "$ref": "result.activities[0].data.confirm_password"
                        }
                    }
                }
            },
            {
                "id": "RESET-PASSWORD-5-A-10",
                "name": "Validate Password",
                "next": "RESET-PASSWORD-5-A-11",
                "type": "SystemTask",
                "lane_id": "VALID-ACTOR",
                "category": "ValidatePasswordTask",
                "parameters": {
                    "input": {
                        "new_password": {
                            "$ref": "bag.new_password"
                        },
                        "confirm_password": {
                            "$ref": "bag.confirm_password"
                        }
                    }
                }
            },
            {
                "id": "RESET-PASSWORD-5-A-11",
                "name": "verify password is valid",
                "next": {
                    "true": "RESET-PASSWORD-5-A-12",
                    "default": "RESET-PASSWORD-5-D-1"
                },
                "type": "Flow",
                "lane_id": "VALID-ACTOR",
                "parameters": {
                    "input": {
                        "key": {
                            "$ref": "result.is_valid"
                        }
                    }
                }
            },
            {
                "id": "RESET-PASSWORD-5-D-1",
                "name": "Notify password invalid",
                "next": "RESET-PASSWORD-5-A-8",
                "type": "UserTask",
                "lane_id": "VALID-ACTOR",
                "parameters": {
                    "input": {
                        "message": "Senha inválida!",
                        "toggleModal": true
                    },
                    "action": "NOTIFY_WARNING",
                    "timeout": 2
                }
            },
            {
                "id": "RESET-PASSWORD-5-A-12",
                "name": "Change Password",
                "next": "RESET-PASSWORD-5-A-13",
                "type": "SystemTask",
                "lane_id": "VALID-ACTOR",
                "category": "ChangePasswordTask",
                "parameters": {
                    "input": {
                        "actor": {
                            "$ref": "bag.actor"
                        },
                        "new_password": {
                            "$ref": "bag.new_password"
                        }
                    }
                }
            },
            {
                "id": "RESET-PASSWORD-5-A-13",
                "name": "Notify success",
                "next": "FINISH",
                "type": "UserTask",
                "lane_id": "VALID-ACTOR",
                "parameters": {
                    "input": {
                        "message": "Senha alterada com sucesso!",
                        "toggleModal": true
                    },
                    "action": "NOTIFY_SUCCESS",
                    "timeout": 2
                }
            },
            {
                "id": "FINISH",
                "name": "Finish",
                "next": null,
                "type": "Finish",
                "lane_id": "VALID-ACTOR"
            }
        ],
        "prepare": [],
        "environment": {},
        "requirements": [
            "core"
        ]
    }
}