{
    "name": "realtorChat",
    "description": "Fluxo de chat entre o corretor e o cliente",
    "blueprint_spec": {
        "lanes": [
            {
                "id": "L",
                "name": "LoggedUser",
                "rule": [
                    "fn",
                    [
                        "actor_data",
                        "bag"
                    ],
                    [
                        "eval",
                        [
                            "apply",
                            "or",
                            [
                                "map",
                                [
                                    "fn",
                                    [
                                        "v"
                                    ],
                                    [
                                        "=",
                                        "v",
                                        [
                                            "`",
                                            "botGeneral"
                                        ]
                                    ]
                                ],
                                [
                                    "get",
                                    "actor_data",
                                    [
                                        "`",
                                        "claims"
                                    ]
                                ]
                            ]
                        ]
                    ]
                ]
            },
            {
                "id": "B&CP",
                "name": "BackOffice",
                "rule": [
                    "fn",
                    [
                        "actor_data",
                        "bag"
                    ],
                    [
                        "or",
                        [
                            "eval",
                            [
                                "apply",
                                "or",
                                [
                                    "map",
                                    [
                                        "fn",
                                        [
                                            "v"
                                        ],
                                        [
                                            "or",
                                            [
                                                "=",
                                                "v",
                                                [
                                                    "`",
                                                    "adminRequests"
                                                ]
                                            ],
                                            [
                                                "=",
                                                "v",
                                                [
                                                    "`",
                                                    "botGeneral"
                                                ]
                                            ]
                                        ]
                                    ],
                                    [
                                        "get",
                                        "actor_data",
                                        [
                                            "`",
                                            "claims"
                                        ]
                                    ]
                                ]
                            ]
                        ],
                        [
                            "eval",
                            [
                                "apply",
                                "or",
                                [
                                    "map",
                                    [
                                        "fn",
                                        [
                                            "v"
                                        ],
                                        [
                                            "=",
                                            "v",
                                            [
                                                "get",
                                                "actor_data",
                                                [
                                                    "`",
                                                    "actor_id"
                                                ]
                                            ]
                                        ]
                                    ],
                                    [
                                        "get",
                                        "bag",
                                        [
                                            "`",
                                            "actors_ids"
                                        ]
                                    ]
                                ]
                            ]
                        ]
                    ]
                ]
            }
        ],
        "nodes": [
            {
                "id": "S",
                "name": "Start node",
                "next": "ST1",
                "type": "Start",
                "lane_id": "L",
                "parameters": {
                    "input_schema": {
                        "type": "object",
                        "required": [
                            "chat_id"
                        ],
                        "properties": {
                            "chat_id": {
                                "type": "string"
                            }
                        },
                        "additionalProperties": false
                    }
                }
            },
            {
                "id": "ST1",
                "name": "Get actors participants and chat history",
                "next": "SB1",
                "type": "SystemTask",
                "lane_id": "L",
                "category": "HTTP",
                "parameters": {
                    "input": {},
                    "request": {
                        "url": {
                            "$mustache": "http://aprova_services:3000/rpc/chat/{{bag.chat_id}}"
                        },
                        "verb": "GET",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        203,
                        204
                    ]
                }
            },
            {
                "id": "SB1",
                "name": "Set ActorId To Bag and chat history",
                "next": "U1",
                "type": "SystemTask",
                "lane_id": "L",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "actors_ids": {
                            "$ref": "result.data.chat_participants_actors_ids"
                        },
                        "chat_details": {
                            "$ref": "result.data"
                        }
                    }
                }
            },
            {
                "id": "U1",
                "name": "Send Message or back-office admin chat",
                "next": "SB2",
                "type": "UserTask",
                "lane_id": "B&CP",
                "parameters": {
                    "input": {
                        "chat_details": {
                            "$ref": "bag.chat_details"
                        },
                        "party_number": {
                            "$ref": "bag.chat_details.buyer_number"
                        },
                        "activity_schema": {
                            "type": "object",
                            "properties": {
                                "action": {
                                    "type": "string"
                                },
                                "message": {
                                    "type": "string"
                                },
                                "external_id": {
                                    "type": "string"
                                },
                                "mobile_phone": {
                                    "type": "string"
                                }
                            },
                            "additionalProperties": false
                        }
                    },
                    "action": "SEND_MESSAGE_OR_ADMIN_CHAT"
                }
            },
            {
                "id": "SB2",
                "name": "Set activity result to bag",
                "next": "F1",
                "type": "SystemTask",
                "lane_id": "L",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "activity_result": {
                            "$ref": "result.activities[0].data"
                        }
                    }
                }
            },
            {
                "id": "F1",
                "name": "Check action",
                "next": {
                    "default": "EXIT-CHAT",
                    "SEND_MESSAGE": "ST2"
                },
                "type": "Flow",
                "lane_id": "B&CP",
                "parameters": {
                    "input": {
                        "key": {
                            "$ref": "bag.activity_result.action"
                        }
                    }
                }
            },
            {
                "id": "ST2",
                "name": "Get chat participant by mobile phone",
                "next": "ST3",
                "type": "SystemTask",
                "lane_id": "B&CP",
                "category": "HTTP",
                "parameters": {
                    "input": {},
                    "request": {
                        "url": {
                            "$mustache": "http://aprova_services:3000/rpc/chat/chat_participant_by_mobile_phone/{{bag.activity_result.mobile_phone}}/{{bag.chat_id}}"
                        },
                        "verb": "GET",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        203,
                        204
                    ]
                }
            },
            {
                "id": "ST3",
                "name": "Save Message",
                "next": "ST1",
                "type": "SystemTask",
                "lane_id": "B&CP",
                "category": "HTTP",
                "parameters": {
                    "input": {
                        "actor": {
                            "$ref": "bag.activity_result.mobile_phone"
                        },
                        "chat_id": {
                            "$ref": "bag.chat_id"
                        },
                        "content": {
                            "$ref": "bag.activity_result.message"
                        },
                        "external_id": {
                            "$ref": "bag.activity_result.external_id"
                        },
                        "chat_participant_id": {
                            "$ref": "result.data.id"
                        }
                    },
                    "request": {
                        "url": {
                            "$mustache": "http://aprova_services:3000/rpc/messages"
                        },
                        "verb": "POST",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        203,
                        204
                    ]
                }
            },
            {
                "id": "EXIT-CHAT",
                "name": "Finish Chat",
                "next": null,
                "type": "Finish",
                "lane_id": "B&CP"
            }
        ],
        "prepare": [],
        "environment": {},
        "requirements": [
            "core"
        ]
    }
}