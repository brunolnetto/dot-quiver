{
    "name": "orderListV2",
    "description": "Workflow para Listagem de pedidos ",
    "blueprint_spec": {
        "lanes": [
            {
                "id": "B",
                "name": "Backoffice",
                "rule": {
                    "$js": "({actor_data}) => actor_data.claims.includes('adminOrderList')"
                }
            },
            {
                "id": "B-LATCHED",
                "name": "Backoffice Latched",
                "rule": {
                    "$js": "({actor_data, bag}) => actor_data.claims.includes('adminOrderList') && actor_data.actor_id === bag.actor_id"
                }
            }
        ],
        "nodes": [
            {
                "id": "S",
                "name": "Start Workflow",
                "next": "B1",
                "type": "Start",
                "lane_id": "B",
                "parameters": {
                    "input_schema": {}
                }
            },
            {
                "id": "B1",
                "name": "Set initial value offset and limit to bag",
                "next": "ST1",
                "type": "SystemTask",
                "lane_id": "B",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "limit": 10,
                        "offset": 0,
                        "filters": {
                            "status": "",
                            "end_date": "",
                            "buyer_name": "",
                            "start_date": "",
                            "buyer_phone": "",
                            "realtor_name": "",
                            "realtor_phone": ""
                        },
                        "actor_id": {
                            "$ref": "actor_data.actor_id"
                        }
                    }
                }
            },
            {
                "id": "ST1",
                "name": "Get Orders",
                "next": "U1",
                "type": "SystemTask",
                "lane_id": "B-LATCHED",
                "category": "HTTP",
                "parameters": {
                    "input": {},
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.SERVICE_API}}}/rpc/requests?offset={{bag.offset}}&limit={{bag.limit}}&buyer_name={{bag.filters.buyer_name}}&realtor_name={{bag.filters.realtor_name}}&buyer_phone={{bag.filters.buyer_phone}}&realtor_phone={{bag.filters.realtor_phone}}&status={{bag.filters.status}}&startDate={{bag.filters.start_date}}&endDate={{bag.filters.end_date}}"
                        },
                        "verb": "GET",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        203,
                        204
                    ]
                }
            },
            {
                "id": "U1",
                "name": "List Orders",
                "next": "B2",
                "type": "UserTask",
                "lane_id": "B-LATCHED",
                "parameters": {
                    "input": {
                        "orders": {
                            "$ref": "result.data"
                        },
                        "activity_schema": {
                            "type": "object",
                            "required": [
                                "option"
                            ],
                            "properties": {
                                "id": {
                                    "type": "string"
                                },
                                "option": {
                                    "type": "string"
                                },
                                "status": {
                                    "type": "string"
                                },
                                "buyer_id": {
                                    "type": "string"
                                },
                                "buyer_name": {
                                    "type": "string"
                                },
                                "created_at": {
                                    "type": "string"
                                },
                                "realtor_id": {
                                    "type": "string"
                                },
                                "credit_limit": {
                                    "type": "string"
                                },
                                "realtor_name": {
                                    "type": "string"
                                },
                                "buyer_mobile_phone": {
                                    "type": "string"
                                },
                                "realtor_mobile_phone": {
                                    "type": "string"
                                }
                            },
                            "additionalProperties": false
                        }
                    },
                    "action": "USER_CHOOSE_ACTION_ORDER_LIST",
                    "activity_manager": "commit"
                }
            },
            {
                "id": "B2",
                "name": "Set activity information to bag",
                "next": "F1",
                "type": "SystemTask",
                "lane_id": "B-LATCHED",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "option": {
                            "$ref": "result.activities[0].data.option"
                        },
                        "result": {
                            "$ref": "result"
                        },
                        "filters": {
                            "$ref": "result.activities[0].data.filters"
                        },
                        "request_id": {
                            "$ref": "result.activities[0].data.id"
                        }
                    }
                }
            },
            {
                "id": "F1",
                "name": "Check option",
                "next": {
                    "LIST": "ST1",
                    "DETAIL": "ST2",
                    "FILTER": "ST1",
                    "RELOAD": "B1",
                    "default": "E",
                    "PAGINATION": "ST5"
                },
                "type": "Flow",
                "lane_id": "B-LATCHED",
                "parameters": {
                    "input": {
                        "key": {
                            "$ref": "result.activities[0].data.option"
                        }
                    }
                }
            },
            {
                "id": "ST2",
                "name": "Detail Order",
                "next": "ST3",
                "type": "SystemTask",
                "lane_id": "B-LATCHED",
                "category": "HTTP",
                "parameters": {
                    "input": {},
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.POSTGREST}}}/requests?id=eq.{{bag.request_id}}"
                        },
                        "verb": "GET",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        203,
                        204
                    ]
                }
            },
            {
                "id": "ST3",
                "name": "Set order to bag",
                "next": "ST4",
                "type": "SystemTask",
                "lane_id": "B-LATCHED",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "order": {
                            "$ref": "result.data[0]"
                        }
                    }
                }
            },
            {
                "id": "ST4",
                "name": "Order Schema",
                "next": "ST6",
                "type": "SystemTask",
                "lane_id": "B-LATCHED",
                "category": "HTTP",
                "parameters": {
                    "input": {},
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.POSTGREST}}}/dev_contracts?key=eq.request_details"
                        },
                        "verb": "GET",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        203,
                        204
                    ]
                }
            },
            {
                "id": "ST6",
                "name": "Set order schema to bag",
                "next": "ST7",
                "type": "SystemTask",
                "lane_id": "B-LATCHED",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "schema": {
                            "$ref": "result.data[0]"
                        }
                    }
                }
            },
            {
                "id": "ST7",
                "name": "Get Profile Data",
                "next": "ST8",
                "type": "SystemTask",
                "lane_id": "B-LATCHED",
                "category": "HTTP",
                "parameters": {
                    "input": {},
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.POSTGREST}}}/profiles?id=eq.{{bag.order.buyer_id}}"
                        },
                        "verb": "GET",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        203,
                        204
                    ]
                }
            },
            {
                "id": "ST8",
                "name": "Set profile data to bag",
                "next": "ST9",
                "type": "SystemTask",
                "lane_id": "B-LATCHED",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "profile": {
                            "$ref": "result.data[0]"
                        }
                    }
                }
            },
            {
                "id": "ST9",
                "name": "Get Realtor Data",
                "next": "ST10",
                "type": "SystemTask",
                "lane_id": "B-LATCHED",
                "category": "HTTP",
                "parameters": {
                    "input": {},
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.POSTGREST}}}/profiles?id=eq.{{bag.order.realtor}}"
                        },
                        "verb": "GET",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        203,
                        204
                    ]
                }
            },
            {
                "id": "ST10",
                "name": "Set realtor data to bag",
                "next": "ST11",
                "type": "SystemTask",
                "lane_id": "B-LATCHED",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "realtor": {
                            "$ref": "result.data[0]"
                        }
                    }
                }
            },
            {
                "id": "ST11",
                "name": "Get proofs Data",
                "next": "SB1",
                "type": "SystemTask",
                "lane_id": "B-LATCHED",
                "category": "HTTP",
                "parameters": {
                    "input": {},
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.SERVICE_API}}}/rpc/requests/{{bag.order.id}}"
                        },
                        "verb": "GET",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        203,
                        204
                    ]
                }
            },
            {
                "id": "SB1",
                "name": "Set proofs data to bag",
                "next": "U2",
                "type": "SystemTask",
                "lane_id": "B-LATCHED",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "proofs": {
                            "$ref": "result.data.proofs"
                        }
                    }
                }
            },
            {
                "id": "U2",
                "name": "List Detail Order",
                "next": "F1",
                "type": "UserTask",
                "lane_id": "B-LATCHED",
                "parameters": {
                    "input": {
                        "proofs": {
                            "$ref": "bag.proofs"
                        },
                        "realtor": {
                            "$ref": "bag.realtor"
                        },
                        "request": {
                            "$ref": "bag.order"
                        },
                        "profiles": {
                            "main": {
                                "$js": "({ bag }) => { const title = { name: bag?.order?.metadata?.profiles?.main?.name?.value, email: bag?.order?.metadata?.profiles?.main?.email?.value, phone: bag?.party_number }; return { ...bag?.order?.metadata?.profiles?.main, title }; };"
                            },
                            "second": {
                                "$js": "({ bag }) => { const title = { name: bag?.order?.metadata?.profiles?.second?.name?.value, email: bag?.order?.metadata?.profiles.second?.email?.value }; return { ...bag?.order?.metadata?.profiles?.second, title }; };"
                            }
                        },
                        "card_data": {
                            "date": {
                                "$ref": "bag.profile.created_at"
                            },
                            "name": {
                                "$ref": "bag.profile.name"
                            },
                            "phone": {
                                "$ref": "bag.profile.mobile_phone"
                            }
                        },
                        "ui_schema": {
                            "$ref": "bag.schema.value.ui_schema"
                        },
                        "activity_schema": {
                            "$ref": "bag.schema.value.activity_schema"
                        },
                        "additionalProperties": false
                    },
                    "action": "USER_CHOOSE_ACTION_ORDER_DETAIL",
                    "activity_manager": "commit"
                }
            },
            {
                "id": "ST5",
                "name": "Set value offset to bag",
                "next": "ST1",
                "type": "SystemTask",
                "lane_id": "B-LATCHED",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "offset": {
                            "$ref": "result.activities[0].data.page"
                        }
                    }
                }
            },
            {
                "id": "E",
                "name": "Finish",
                "next": null,
                "type": "Finish",
                "lane_id": "B-LATCHED"
            }
        ],
        "prepare": [],
        "environment": {
            "POSTGREST": "POSTGREST",
            "SERVICE_API": "SERVICE_API"
        },
        "requirements": [
            "core"
        ]
    }
}