{
    "name": "appAccessAprovaRealtor",
    "description": "Fluxo único de entrada no app pelo Corretor",
    "blueprint_spec": {
        "lanes": [
            {
                "id": "A",
                "name": "Anonymous",
                "rule": {
                    "$js": "({actor_data}) => actor_data.claims.includes('anonymous')"
                }
            },
            {
                "id": "L",
                "name": "LoggedUser",
                "rule": {
                    "$js": "({actor_data}) => actor_data.claims.includes('useApp')"
                }
            },
            {
                "id": "L-LATCHED",
                "name": "LoggedUser Latched",
                "rule": {
                    "$js": "({bag, actor_data}) => bag.actor_id === actor_data.actor_id && actor_data.claims.includes('useApp')"
                }
            },
            {
                "id": "A-LATCHED",
                "name": "Anonymous Latched",
                "rule": {
                    "$js": "({bag, actor_data}) => bag.session_id === actor_data.session_id && actor_data.claims.includes('anonymous')"
                }
            }
        ],
        "nodes": [
            {
                "id": "SA-1",
                "name": "Start as Logged User",
                "next": "ST10",
                "type": "Start",
                "lane_id": "L",
                "parameters": {
                    "input_schema": {}
                }
            },
            {
                "id": "ST10",
                "name": "Get profile",
                "next": "SB5",
                "type": "SystemTask",
                "lane_id": "L",
                "category": "HTTP",
                "parameters": {
                    "input": {},
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.POSTGREST}}}/profiles?actor_id=eq.{{actor_data.actor_id}}"
                        },
                        "verb": "GET",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        203,
                        204
                    ]
                }
            },
            {
                "id": "SB5",
                "name": "Set profile to bag",
                "next": "ST7-L",
                "type": "SystemTask",
                "lane_id": "L",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "profile": {
                            "$ref": "result.data[0]"
                        },
                        "actor_id": {
                            "$ref": "actor_data.actor_id"
                        }
                    }
                }
            },
            {
                "id": "ST7-L",
                "name": "Start home workflow ",
                "next": "U7-L",
                "type": "SystemTask",
                "lane_id": "L-LATCHED",
                "category": "startProcess",
                "parameters": {
                    "input": {
                        "limit": 10,
                        "offset": 0
                    },
                    "actor_data": {
                        "$ref": "actor_data"
                    },
                    "workflow_name": "home"
                }
            },
            {
                "id": "U7-L",
                "name": "Notify Change Process Focus",
                "next": "E",
                "type": "UserTask",
                "lane_id": "L-LATCHED",
                "parameters": {
                    "input": {
                        "new_process_id": {
                            "$ref": "result"
                        }
                    },
                    "action": "CHANGE_PROCESS_FOCUS",
                    "timeout": 60
                }
            },
            {
                "id": "SA",
                "name": "Start Anonymous",
                "next": "ST4",
                "type": "Start",
                "lane_id": "A",
                "parameters": {
                    "input_schema": {}
                }
            },
            {
                "id": "ST4",
                "name": "Get account settings",
                "next": "SB2",
                "type": "SystemTask",
                "lane_id": "A",
                "category": "HTTP",
                "parameters": {
                    "input": {},
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.POSTGREST}}}/accounts"
                        },
                        "verb": "GET",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        203,
                        204
                    ]
                }
            },
            {
                "id": "SB2",
                "name": "Save default claims to bag",
                "next": "U1",
                "type": "SystemTask",
                "lane_id": "A",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "account_id": {
                            "$ref": "result.data[0].id"
                        },
                        "session_id": {
                            "$ref": "actor_data.session_id"
                        },
                        "default_claims": {
                            "$ref": "result.data[0].settings.default_user_claims"
                        }
                    }
                }
            },
            {
                "id": "U1",
                "name": "Get Login Information",
                "next": "SB1",
                "type": "UserTask",
                "lane_id": "A-LATCHED",
                "parameters": {
                    "input": {
                        "text": "Para continuar insira o seu celular e confirme o código de confirmação",
                        "title": "Acesso",
                        "phoneInputIcon": "phone-outline",
                        "activity_schema": {
                            "type": "object",
                            "required": [
                                "mobile_phone"
                            ],
                            "properties": {
                                "mobile_phone": {
                                    "type": "string"
                                }
                            },
                            "additionalProperties": false
                        },
                        "phoneInputLabel": "Celular",
                        "loginButtonLabel": "Entrar",
                        "phoneInputPlaceholder": "(00) 0000-0000"
                    },
                    "action": "LOGIN"
                }
            },
            {
                "id": "SB1",
                "name": "Saves phone generate Token and Set To Bag",
                "next": "SB1-1",
                "type": "SystemTask",
                "lane_id": "A-LATCHED",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "token": {
                            "$js": "() => `${Math.floor(1000 + Math.random() * 9000)}`"
                        },
                        "mobile_phone": {
                            "$ref": "result.activities[0].data.mobile_phone"
                        }
                    }
                }
            },
            {
                "id": "SB1-1",
                "name": "Verify profile as active",
                "next": "SB1-2",
                "type": "SystemTask",
                "lane_id": "A-LATCHED",
                "category": "HTTP",
                "parameters": {
                    "input": {},
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.SERVICE_API}}}/rpc/profiles/{{bag.mobile_phone}}"
                        },
                        "verb": "GET",
                        "headers": {
                            "Prefer": "return=representation",
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        203,
                        204
                    ]
                }
            },
            {
                "id": "SB1-2",
                "name": "realtor is active",
                "next": {
                    "REALTOR": "ST1",
                    "default": "U3"
                },
                "type": "Flow",
                "lane_id": "A-LATCHED",
                "parameters": {
                    "input": {
                        "key": {
                            "$ref": "result.data.role"
                        }
                    }
                }
            },
            {
                "id": "U3",
                "name": "send message if realtor is inactive",
                "next": "SB1-3",
                "type": "UserTask",
                "lane_id": "A-LATCHED",
                "parameters": {
                    "input": {
                        "text": "O numero informado esta desabilitado na base",
                        "title": "Corretor Indisponivel",
                        "buttonLabel": "Ok",
                        "activity_schema": {
                            "type": "object",
                            "required": [
                                "confirm"
                            ],
                            "properties": {
                                "confirm": {
                                    "type": "boolean"
                                }
                            },
                            "additionalProperties": false
                        }
                    },
                    "action": "REALTOR_INACTIVE"
                }
            },
            {
                "id": "SB1-3",
                "name": "Finish node",
                "next": null,
                "type": "Finish",
                "lane_id": "A-LATCHED"
            },
            {
                "id": "ST1",
                "name": "Send token sms",
                "next": "U2",
                "type": "SystemTask",
                "lane_id": "A-LATCHED",
                "category": "HTTP",
                "parameters": {
                    "input": {
                        "phone": {
                            "$ref": "bag.mobile_phone"
                        },
                        "message": {
                            "$mustache": "Aprova App, utilize o token {{ bag.token }} para realizar seu acesso"
                        }
                    },
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.SERVICE_API}}}/rpc/token/send"
                        },
                        "verb": "POST",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200
                    ]
                }
            },
            {
                "id": "U2",
                "name": "Get Verification Information",
                "next": "F1",
                "type": "UserTask",
                "lane_id": "A-LATCHED",
                "parameters": {
                    "input": {
                        "text": "Insira o código que foi enviado para o seu telefone:",
                        "error": "",
                        "phone": {
                            "$ref": "bag.mobile_phone"
                        },
                        "title": "Verificação",
                        "codeInputLabel": "Insira o código",
                        "expirationTime": 120,
                        "phoneInputIcon": "phone-outline",
                        "activity_schema": {
                            "type": "object",
                            "required": [
                                "token"
                            ],
                            "properties": {
                                "token": {
                                    "type": "string"
                                },
                                "option": {
                                    "type": "string"
                                }
                            },
                            "additionalProperties": false
                        },
                        "retryButtonLabel": "Gerar novo código",
                        "confirmButtonLabel": "Confirmar",
                        "codeInputPlaceholder": "0000"
                    },
                    "action": "VERIFICATION"
                }
            },
            {
                "id": "F1",
                "name": "Default Flow",
                "next": {
                    "cancel": "E",
                    "return": "U1",
                    "default": "F2",
                    "new_token": "ST1"
                },
                "type": "Flow",
                "lane_id": "A-LATCHED",
                "parameters": {
                    "input": {
                        "key": {
                            "$ref": "result.activities[0].data.option"
                        }
                    }
                }
            },
            {
                "id": "F2",
                "name": "Check token?",
                "next": {
                    "default": "U4",
                    "token_ok": "ST2",
                    "token_error": "U4"
                },
                "type": "Flow",
                "lane_id": "A-LATCHED",
                "parameters": {
                    "input": {
                        "key": {
                            "$js": "({bag, result}) => (result.activities[0].data.token === bag.token) ? 'token_ok' :  'token_error'"
                        }
                    }
                }
            },
            {
                "id": "ST2",
                "name": "Get User information",
                "next": "F3",
                "type": "SystemTask",
                "lane_id": "A-LATCHED",
                "category": "HTTP",
                "parameters": {
                    "input": {},
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.POSTGREST}}}/profiles?mobile_phone=eq.{{ bag.mobile_phone }}"
                        },
                        "verb": "GET",
                        "headers": {
                            "Prefer": "return=representation",
                            "ContentType": "application/json"
                        }
                    },
                    "valid_response_codes": [
                        200,
                        203,
                        204
                    ]
                }
            },
            {
                "id": "F3",
                "name": "User aleready exists?",
                "next": {
                    "true": "ST6",
                    "default": "U5"
                },
                "type": "Flow",
                "lane_id": "A-LATCHED",
                "parameters": {
                    "input": {
                        "key": {
                            "$js": "({result}) => (result.data.length > 0) ? true :  false"
                        }
                    }
                }
            },
            {
                "id": "U5",
                "name": "Notify user does not exist",
                "next": "F4",
                "type": "UserTask",
                "lane_id": "A-LATCHED",
                "parameters": {
                    "input": {
                        "text": "Corretor não cadastrado no sistema!",
                        "activity_schema": {
                            "type": "object",
                            "required": [
                                "option"
                            ],
                            "properties": {
                                "option": {
                                    "type": "string"
                                }
                            },
                            "additionalProperties": false
                        }
                    },
                    "action": "NOTIFY_REALTOR_DOESNT_EXIST"
                }
            },
            {
                "id": "F4",
                "name": "Check Ack action",
                "next": {
                    "return": "U1",
                    "default": "E"
                },
                "type": "Flow",
                "lane_id": "A-LATCHED",
                "parameters": {
                    "input": {
                        "key": {
                            "$ref": "result.activities[0].data.option"
                        }
                    }
                }
            },
            {
                "id": "ST6",
                "name": "Login",
                "next": "SB3",
                "type": "SystemTask",
                "lane_id": "A-LATCHED",
                "category": "HTTP",
                "parameters": {
                    "input": {
                        "actor": {
                            "$ref": "bag.mobile_phone"
                        }
                    },
                    "request": {
                        "url": {
                            "$mustache": "{{{environment.SERVICE_API}}}/rpc/login"
                        },
                        "verb": "POST",
                        "headers": {
                            "ContentType": "application/json"
                        }
                    }
                }
            },
            {
                "id": "SB3",
                "name": "Set profile and login to bag",
                "next": "U6",
                "type": "SystemTask",
                "lane_id": "A-LATCHED",
                "category": "SetToBag",
                "parameters": {
                    "input": {
                        "login": {
                            "$ref": "result.data.login"
                        },
                        "profile": {
                            "$ref": "result.data.profile"
                        },
                        "actor_id": {
                            "$ref": "result.data.login.actor_id"
                        }
                    }
                }
            },
            {
                "id": "U6",
                "name": "Receive login Info",
                "next": "ST7",
                "type": "UserTask",
                "lane_id": "A-LATCHED",
                "parameters": {
                    "input": {
                        "login": {
                            "$ref": "bag.login"
                        },
                        "activity_schema": {
                            "type": "object",
                            "required": [
                                "ack"
                            ],
                            "properties": {
                                "ack": {
                                    "type": "boolean"
                                },
                                "option": {
                                    "type": "string"
                                }
                            },
                            "additionalProperties": false
                        }
                    },
                    "action": "RECEIVE_LOGIN_INFO"
                }
            },
            {
                "id": "ST7",
                "name": "Start home workflow ",
                "next": "U7",
                "type": "SystemTask",
                "lane_id": "L-LATCHED",
                "category": "startProcess",
                "parameters": {
                    "input": {
                        "limit": 10,
                        "offset": 0
                    },
                    "actor_data": {
                        "claims": {
                            "$ref": "bag.login.claims"
                        },
                        "actor_id": {
                            "$ref": "bag.login.actor_id"
                        },
                        "account_id": {
                            "$ref": "bag.login.account_id"
                        }
                    },
                    "workflow_name": "RealtorAppHome"
                }
            },
            {
                "id": "U7",
                "name": "Notify Change Process Focus",
                "next": "E",
                "type": "UserTask",
                "lane_id": "L-LATCHED",
                "parameters": {
                    "input": {
                        "new_process_id": {
                            "$ref": "result"
                        }
                    },
                    "action": "CHANGE_PROCESS_FOCUS",
                    "timeout": 60
                }
            },
            {
                "id": "U4",
                "name": "Get Verification Information Again",
                "next": "F1",
                "type": "UserTask",
                "lane_id": "A-LATCHED",
                "parameters": {
                    "input": {
                        "text": "Insira o código que foi enviado para o seu telefone:",
                        "error": "Código inserido está incorreto!",
                        "phone": {
                            "$ref": "bag.mobile_phone"
                        },
                        "title": "Verificação",
                        "codeInputLabel": "Insira o código",
                        "expirationTime": 120,
                        "phoneInputIcon": "phone-outline",
                        "activity_schema": {
                            "type": "object",
                            "required": [
                                "token"
                            ],
                            "properties": {
                                "token": {
                                    "type": "string"
                                },
                                "option": {
                                    "type": "string"
                                }
                            },
                            "additionalProperties": false
                        },
                        "retryButtonLabel": "Gerar novo código",
                        "confirmButtonLabel": "Confirmar",
                        "codeInputPlaceholder": "0000"
                    },
                    "action": "VERIFICATION"
                }
            },
            {
                "id": "E",
                "name": "Finish node",
                "next": null,
                "type": "Finish",
                "lane_id": "L-LATCHED"
            }
        ],
        "prepare": [],
        "environment": {
            "POSTGREST": "POSTGREST",
            "SERVICE_API": "SERVICE_API"
        },
        "requirements": [
            "core"
        ]
    }
}